import { describe, expect, it } from "bun:test";
import {
  getExploitTemplate,
  listExploitTemplates,
} from "../src/orchestration/exploit-templates";

describe("exploit templates", () => {
  it("lists templates (ALL)", () => {
    const listed = listExploitTemplates();
    expect(listed.length > 0).toBe(true);
    expect(listed.some((t) => t.domain === "PWN")).toBe(true);
    expect(listed.some((t) => t.domain === "WEB3")).toBe(true);
    expect(listed.some((t) => t.domain === "MISC")).toBe(true);
  });

  it("lists templates by domain", () => {
    const pwn = listExploitTemplates("PWN");
    const crypto = listExploitTemplates("CRYPTO");
    const web3 = listExploitTemplates("WEB3");
    const misc = listExploitTemplates("MISC");
    expect(pwn.every((t) => t.domain === "PWN")).toBe(true);
    expect(crypto.every((t) => t.domain === "CRYPTO")).toBe(true);
    expect(web3.every((t) => t.domain === "WEB3")).toBe(true);
    expect(misc.every((t) => t.domain === "MISC")).toBe(true);
  });

  it("gets template body by id", () => {
    const listed = listExploitTemplates("PWN");
    const first = listed[0];
    expect(first).toBeTruthy();
    const full = getExploitTemplate("PWN", first?.id ?? "");
    expect(full).not.toBeNull();
    expect(typeof full?.body).toBe("string");
    expect((full?.body ?? "").length > 0).toBe(true);
  });

  it("gets WEB3 and MISC template bodies by id", () => {
    const web3List = listExploitTemplates("WEB3");
    const miscList = listExploitTemplates("MISC");
    expect(web3List.length > 0).toBe(true);
    expect(miscList.length > 0).toBe(true);

    const web3 = getExploitTemplate("WEB3", web3List[0]?.id ?? "");
    const misc = getExploitTemplate("MISC", miscList[0]?.id ?? "");
    expect(web3).not.toBeNull();
    expect(misc).not.toBeNull();
    expect((web3?.body ?? "").length > 0).toBe(true);
    expect((misc?.body ?? "").length > 0).toBe(true);
  });
});
